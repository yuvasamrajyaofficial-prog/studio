rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if the user is the owner of the document (using uid field)
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Check if the user is an Admin
    // We check against a hardcoded list of admin emails for security
    // OR a custom claim if you implement that later.
    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.email.matches('^.*@gmail[.]com$') && (
          request.auth.token.email == 'prashantbhiremath13@gmail.com' ||
          request.auth.token.email == 'ph293815@gmail.com'
        )
      );
    }

    // --- Collection Rules ---

    // Users Collection
    match /users/{userId} {
      // Admins can read/write everything
      allow read, write: if isAdmin();
      
      // Owners can read their own profile
      allow get: if isOwner(userId);
      
      // Creation: Allow if auth uid matches doc id AND data.uid matches
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      
      // Update: Allow if owner, but prevent changing critical fields like uid or role (unless admin)
      allow update: if isOwner(userId) 
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.role == resource.data.role;
        
      // Delete: Only admins or owner can delete
      allow delete: if isOwner(userId);
    }

    // Scriptures Collection (Public Read, Admin Write)
    match /scriptures/{scriptureId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Blogs/Articles Collection (Public Read, Admin Write)
    match /blogs/{blogId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Projects (User Private)
    match /projects/{projectId} {
      allow read, write: if isAdmin();
      allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid;
      allow read, update, delete: if isSignedIn() && resource.data.ownerUid == request.auth.uid;
    }

    // Voices (User Private + Admin)
    match /voices/{voiceId} {
      allow read, write: if isAdmin();
      allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid;
      allow read, update, delete: if isSignedIn() && resource.data.ownerUid == request.auth.uid;
    }

    // App Config (Public Read, Admin Write)
    match /appConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
